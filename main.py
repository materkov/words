import json
from navec import Navec
from flask import Flask
from flask import request
import time
import random

#path = '/Users/m.materkov/Downloads/navec_hudlit_v1_12B_500K_300d_100q.tar'
path = '/apps/words/db.tar'
navec = Navec.load(path)

#path_similar = 'result.txt'
path_similar = '/apps/words/similar.txt'
file_similar = open(path_similar, 'r')
similar_lines = file_similar.readlines()
file_similar.close()

similar_dict = {}
for line in similar_lines:
    data = json.loads(line)
    similar_dict[data['word']] = data['sim']

#path = '/apps/words/db.tar'
navec = Navec.load(path)

app = Flask(__name__)

our_epoch = 1669150800  # Thu Nov 24 2022 00:00:00 GMT+0300 (GMT+03:00)

good_words = [
    'идея', 'процедура', 'этап', 'порядок', 'сотня', 'мужик', 'магазин', 'представление', 'платье', 'книжка',
    'торговля', 'информация', 'ворота', 'разговор', 'министерство', 'редактор', 'пистолет', 'внимание',
    'творчество', 'труд', 'новость', 'озеро', 'покупатель', 'сюжет', 'вера', 'ставка', 'вершина', 'возраст',
    'старик', 'экран', 'команда', 'метод', 'высота', 'средство', 'речь', 'честь', 'эксперт', 'профессор',
    'бумага', 'чиновник', 'деньги', 'собственность', 'нож', 'помощь', 'заявление', 'образование', 'отрасль',
    'майор', 'враг', 'лед', 'воздух', 'миг', 'июнь', 'тысяча', 'удовольствие', 'толпа', 'слово', 'житель',
    'требование', 'бог', 'список', 'господь', 'школа', 'восторг', 'обеспечение', 'сон', 'ребята', 'стиль',
    'капитан', 'опасность', 'точка', 'роман', 'нефть', 'указание', 'основное', 'изменение', 'вопрос',
    'группа', 'среда', 'запад', 'давление', 'смена', 'обязательство', 'следователь', 'мама', 'выход', 'цвет',
    'сотрудник', 'осень', 'запас', 'главное', 'депутат', 'температура', 'предел', 'помещение', 'источник',
    'соглашение', 'кино', 'здание', 'объект', 'поведение', 'отличие', 'просьба', 'судья', 'живот', 'король',
    'положение', 'диван', 'начало', 'день', 'руководство', 'отказ', 'шум', 'дед', 'родина', 'смех',
    'действие', 'ожидание', 'море', 'технология', 'лев', 'свидетель', 'мешок', 'угол', 'канал', 'ящик',
    'ситуация', 'сентябрь', 'материал', 'девочка', 'зал', 'храм', 'сказка', 'борьба', 'убийство',
    'государство', 'черта', 'прошлое', 'глава', 'дядя', 'счастье', 'столик', 'преступление', 'признание',
    'дверь', 'сторона', 'замок', 'сумма', 'музей', 'строительство', 'кризис', 'жена', 'данные', 'лето',
    'продукция', 'производство', 'игра', 'автомат', 'сравнение', 'взаимодействие', 'профессия', 'республика',
    'длина', 'господин', 'энергия', 'проверка', 'повод', 'увеличение', 'изображение', 'дело', 'пиво',
    'достижение', 'баба', 'промышленность', 'представитель', 'конец', 'крест', 'водитель', 'герой', 'издание',
    'практика', 'конфликт', 'рот', 'победа', 'законодательство', 'музыка', 'слой', 'создание', 'спина',
    'стоимость', 'наличие', 'характеристика', 'угроза', 'категория', 'женщина', 'лист', 'интерес', 'режиссер',
    'коммунист', 'рынок', 'секретарь', 'рассмотрение', 'дружба', 'нога', 'потеря', 'хлеб', 'глубина', 'улица',
    'случай', 'обработка', 'пора', 'потребность', 'масло', 'сумка', 'цветок', 'кодекс', 'набор', 'брат',
    'мечта', 'впечатление', 'администрация', 'смысл', 'пример', 'множество', 'письмо', 'потолок', 'столица',
    'зеркало', 'отделение', 'середина', 'буква', 'жертва', 'спор', 'фон', 'линия', 'исключение',
    'родственник', 'зуб', 'кровать', 'революция', 'обстоятельство', 'прокурор', 'рыба', 'публика', 'система',
    'пара', 'месяц', 'план', 'зависимость', 'кресло', 'реклама', 'проблема', 'сообщение', 'деятельность',
    'фактор', 'станция', 'штат', 'стихи', 'последствие', 'цифра', 'снижение', 'лагерь', 'гость', 'воспитание',
    'свобода', 'почва', 'яблоко', 'постель', 'формула', 'акт', 'уровень', 'соответствие', 'работник', 'врач',
    'жизнь', 'пункт', 'услуга', 'редакция', 'переговоры', 'колено', 'сестра', 'камера', 'состав', 'понятие',
    'воля', 'дума', 'атмосфера', 'свет', 'охрана', 'предприятие', 'конкурс', 'обязанность', 'центр',
    'родитель', 'волос', 'вечер', 'поиск', 'фотография', 'произведение', 'контакт', 'участок', 'кредит',
    'поезд', 'район', 'статус', 'разработка', 'известие', 'комитет', 'немец', 'структура', 'мать', 'очередь',
    'серия', 'деревня', 'взгляд', 'голова', 'сутки', 'память', 'папа', 'рисунок', 'собрание', 'палец',
    'степень', 'председатель', 'объем', 'глаз', 'поселок', 'расстояние', 'январь', 'власть', 'явление',
    'учет', 'влияние', 'схема', 'разница', 'решение', 'губа', 'километр', 'кожа', 'основание', 'лес', 'мост',
    'безопасность', 'поверхность', 'город', 'кровь', 'год', 'обед', 'бой', 'фирма', 'статья', 'ресторан',
    'мероприятие', 'художник', 'покой', 'кабинет', 'служба', 'лестница', 'вывод', 'вкус', 'колесо', 'вход',
    'возможность', 'звонок', 'доллар', 'мгновение', 'кофе', 'голос', 'ряд', 'удивление', 'заказ', 'весна',
    'полет', 'механизм', 'обращение', 'подразделение', 'зима', 'сосед', 'реальность', 'окно', 'русский',
    'счет', 'неделя', 'фонд', 'жилье', 'слух', 'поэзия', 'норма', 'шанс', 'старуха', 'академия', 'тетя',
    'проведение', 'гора', 'знак', 'руководитель', 'поддержка', 'звук', 'страсть', 'улыбка', 'село',
    'активность', 'история', 'артист', 'масштаб', 'открытие', 'мир', 'огонь', 'мясо', 'должность', 'ноябрь',
    'элемент', 'офицер', 'животное', 'присутствие', 'приятель', 'тюрьма', 'талант', 'судьба', 'мощность',
    'утро', 'организм', 'корабль', 'июль', 'эффективность', 'цена', 'радость', 'принятие', 'круг', 'сигнал',
    'масса', 'товарищ', 'дача', 'стена', 'площадь', 'министр', 'газета', 'сеть', 'выполнение', 'специалист',
    'книга', 'начальство', 'тень', 'тон', 'стул', 'владелец', 'образ', 'еврей', 'партнер', 'ключ', 'условие',
    'банк', 'роль', 'получение', 'защита', 'существование', 'труба', 'объединение', 'монастырь', 'комплекс',
    'фильм', 'федерация', 'инициатива', 'философия', 'понимание', 'ответственность', 'основа', 'суть',
    'спорт', 'желание', 'миллион', 'способность', 'знакомый', 'партия', 'ребенок', 'концепция', 'величина',
    'показатель', 'растение', 'опыт', 'добро', 'часы', 'самолет', 'снег', 'учитель', 'оборудование',
    'концерт', 'документ', 'препарат', 'срок', 'отдел', 'писатель', 'приказ', 'аппарат', 'муж', 'соединение',
    'определение', 'граница', 'лошадь', 'плата', 'праздник', 'сезон', 'гостиница', 'союз', 'целое', 'оборона',
    'полковник', 'организация', 'постановление', 'факт', 'позиция', 'автор', 'культура', 'оценка', 'командир',
    'любовь', 'печать', 'пол', 'закон', 'экономика', 'крик', 'бутылка', 'устройство', 'спектакль', 'фамилия',
    'вино', 'назначение', 'сапог', 'карман', 'мастер', 'пост', 'возвращение', 'волна', 'усилие', 'отсутствие',
    'чтение', 'реформа', 'бюджет', 'слеза', 'продажа', 'дорога', 'итог', 'клетка', 'парк', 'клуб', 'ум',
    'грех', 'стекло', 'применение', 'сила', 'реакция', 'сигарета', 'тема', 'страница', 'темнота', 'лицо',
    'вид', 'период', 'армия', 'автомобиль', 'остров', 'коридор', 'скорость', 'тенденция', 'исследование',
    'том', 'восток', 'адрес', 'фраза', 'черт', 'предложение', 'ощущение', 'недостаток', 'строй', 'кусок',
    'автобус', 'душа', 'сомнение', 'обучение', 'студент', 'результат', 'дурак', 'песок', 'уход', 'одежда',
    'следствие', 'собака', 'настроение', 'хвост', 'рассказ', 'вариант', 'подарок', 'семья', 'сочинение',
    'таблица', 'наблюдение', 'солдат', 'вес', 'полоса', 'сотрудничество', 'война', 'запись', 'детство',
    'природа', 'частность', 'версия', 'премия', 'рамка', 'билет', 'земля', 'трава', 'время', 'доход',
    'размер', 'телефон', 'род', 'сделка', 'фигура', 'сущность', 'число', 'этаж', 'общение', 'отдых',
    'февраль', 'имущество', 'молоко', 'крыло', 'население', 'войско', 'противник', 'номер', 'дыхание',
    'эффект', 'зло', 'лидер', 'воспоминание', 'продукт', 'актер', 'чай', 'участник', 'порог', 'поворот',
    'событие', 'программа', 'газ', 'металл', 'машина', 'чувство', 'личность', 'количество', 'режим', 'карта',
    'коллега', 'ответ', 'движение', 'шея', 'психология', 'корпус', 'москвич', 'заключение', 'поездка', 'стол',
    'связь', 'красота', 'объяснение', 'традиция', 'зритель', 'фронт', 'значение', 'проект', 'ухо', 'дождь',
    'беседа', 'кость', 'кандидат', 'шаг', 'американец', 'помощник', 'образец', 'название', 'хозяин', 'дерево',
    'сфера', 'поколение', 'танец', 'дочка', 'журналист', 'камень', 'костюм', 'мужчина', 'транспорт', 'модель',
    'край', 'выставка', 'журнал', 'регион', 'институт', 'ветер', 'телевизор', 'театр', 'путь', 'стакан',
    'расчет', 'метр', 'зарплата', 'берег', 'форма', 'вода', 'записка', 'искусство', 'сбор', 'ракета',
    'субъект', 'сад', 'польза', 'деталь', 'вещество', 'секунда', 'дым', 'грудь', 'дама', 'вирус', 'поток',
    'тишина', 'библиотека', 'смерть', 'начальник', 'территория', 'процент', 'пенсия', 'река', 'час', 'слава',
    'подруга', 'выборы', 'мальчишка', 'тайна', 'птица', 'боль', 'бизнес', 'половина', 'зрение', 'член', 'дух',
    'небо', 'необходимость', 'площадка', 'функция', 'народ', 'совесть', 'единица', 'сердце', 'причина',
    'минута', 'текст', 'еда', 'человек', 'качество', 'мысль', 'золото', 'доктор', 'рост', 'встреча',
    'выражение', 'двор', 'суд', 'перевод', 'ладонь', 'производитель', 'успех', 'теория', 'здоровье',
    'описание', 'дно', 'десяток', 'март', 'мнение', 'вина', 'изучение', 'очки', 'передача', 'страна', 'тип',
    'направление', 'сожаление', 'тело', 'строка', 'краска', 'клиент', 'апрель', 'коллектив', 'вагон', 'пьеса',
    'ученый', 'октябрь', 'подготовка', 'ошибка', 'гражданин', 'выбор', 'хозяйка', 'договор', 'водка',
    'солнце', 'удар', 'сын', 'человечество', 'существо', 'директор', 'рука', 'остаток', 'конференция',
    'ценность', 'правило', 'пакет', 'выступление', 'обстановка', 'лейтенант', 'инженер', 'характер', 'песня',
    'блок', 'мозг', 'рабочий', 'заседание', 'установка', 'хозяйство', 'лодка', 'кадр', 'затрата', 'комиссия',
    'компьютер', 'забота', 'часть', 'друг', 'памятник', 'заместитель', 'способ', 'чудо', 'оплата', 'сведение',
    'доска', 'правда', 'чемпионат', 'парень', 'страх', 'параметр', 'шутка', 'повышение', 'болезнь',
    'операция', 'окончание', 'реализация', 'рубль', 'кольцо', 'губернатор', 'право', 'генерал', 'корень',
    'принцип', 'декабрь', 'риск', 'налог', 'предмет', 'больной', 'разрешение', 'читатель', 'кулак', 'рубеж',
    'нарушение', 'эпоха', 'мальчик', 'брак', 'компания', 'подход', 'управление', 'оружие', 'бабушка', 'штаб',
    'имя', 'переход', 'капитал', 'плечо', 'работа', 'анализ', 'сознание', 'пространство', 'беда', 'сцена',
    'появление', 'знание', 'дом', 'прием', 'август', 'штука', 'учреждение', 'литература', 'завод', 'урок',
    'правительство', 'квартира', 'куст', 'доклад', 'использование', 'исполнение', 'особенность',
    'формирование', 'нос', 'момент', 'испытание', 'округ', 'вещь', 'задача', 'техника', 'контроль', 'подъезд',
    'содержание', 'горло', 'признак', 'достоинство', 'кухня', 'взрыв', 'танк', 'выпуск', 'отец', 'орган',
    'молодежь', 'течение', 'милиция', 'звезда', 'ход', 'комната', 'запах', 'ручка', 'эксплуатация', 'пыль',
    'доля', 'большинство', 'наука', 'область', 'поле', 'конструкция', 'процесс', 'ресурс', 'политика',
    'свойство', 'цель', 'инструмент', 'дочь', 'акция', 'палата', 'университет', 'ремонт', 'отношение', 'щека',
    'долг', 'крыша', 'будущее', 'девушка', 'общество', 'товар', 'язык', 'класс', 'картина', 'ночь',
    'действительность', 'след', 'президент', 'мера', 'место', 'май', 'расход', 'лоб', 'дворец', 'совет',
    'эксперимент', 'век', 'зона', 'состояние', 'двигатель', 'ученик', 'воздействие', 'царь', 'поэт',
    'надежда', 'бок', 'раз', 'больница', 'рождение', 'участие', 'курс', 'доказательство', 'трубка',
    'перспектива', 'база', 'занятие', 'портрет', 'ужас', 'развитие', 'князь', 'попытка', 'церковь'
]


def current_game():
    game_id = int((time.time() - our_epoch) / 86400)
    return game_id


@app.route("/getGameState", methods=['POST'])
def get_game_state():
    cur_game = current_game()
    return {"response": {
        "currentGameId": cur_game,
        "gameGroups": [
            {
                "language": "RU",
                "games": list(range(1, cur_game)),
            }
        ]
    }}


@app.route("/checkWord", methods=['POST'])
def check_word():
    body = request.get_json(True, True)
    if not body:
        return {"error": "incorrect body"}

    try:
        game_id = int(body.get('gameId', ''))
    except Exception:
        game_id = 0

    if game_id <= 0 or game_id > current_game():
        return {"error": "incorrect gameId"}

    word = str(body.get('wordValue', '')).strip()
    if word == "":
        return {"error": "empty word"}

    if navec.get(word) is None:
        return {"response": {"score": 0, "status": "NOT_FOUND"}}

    if word == good_words[current_game()]:
        return {"response": {"score": 1, "status": "WIN"}}

    similarity = float(navec.sim(good_words[current_game()], word))
    if similarity < 0:
        similarity = 0

    return {"response": {"score": similarity, "status": "SIMILAR"}}


@app.route("/giveUp", methods=['POST'])
def give_up():
    body = request.get_json(True, True)
    if not body:
        return {"error": "incorrect body"}

    try:
        game_id = int(body.get('gameId', ''))
    except Exception:
        game_id = 0

    if game_id <= 0 or game_id > current_game():
        return {"error": "incorrect gameId"}

    return {"response": {"word": {"value": good_words[game_id], "score": 1}}}


@app.route("/getTip", methods=['POST'])
def get_tip():
    body = request.get_json(True, True)
    if not body:
        return {"error": "incorrect body"}

    try:
        game_id = int(body.get('gameId', ''))
    except Exception:
        game_id = 0

    if game_id <= 0 or game_id > current_game():
        return {"error": "incorrect gameId"}

    try:
        tip_number = int(body.get('tipNumber', ''))
    except Exception:
        tip_number = 0

    if tip_number < 1 or tip_number > 50:
        return {"error": "incorrect tipNumber"}

    current_word = good_words[current_game()]

    shuffled_similar = list(similar_dict[current_word].keys())
    random.Random(game_id).shuffle(shuffled_similar)

    tip_word = shuffled_similar[tip_number-1]

    return {"response": {"word": {
        "value": tip_word,
        "score": similar_dict[current_word][tip_word]
    }}}
